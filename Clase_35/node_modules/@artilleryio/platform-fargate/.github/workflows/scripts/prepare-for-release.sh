#!/usr/bin/env bash

set -eu -o pipefail

declare -r DEPENDENCIES=(uglifyjs)
check_dependencies () {
    for dep in "${DEPENDENCIES[@]}" ; do
        set +e
        if ! command -v "$dep" > /dev/null ; then
            echo "Error: could not find $dep in \$PATH. Please install $dep."
            exit $ERR_DEP
        fi
        set -e
    done
}

check_dependencies

commit_sha=$GITHUB_SHA
echo "Commit SHA: $commit_sha"

#
# replace the Docker worker image version:
#
echo "replacing Docker tag in: lib/constants.js"
sed -i "s/const\ DEFAULT_IMAGE_TAG.*=.*'latest'/const DEFAULT_IMAGE_TAG='${commit_sha}'/" lib/constants.js
grep "$commit_sha" lib/constants.js
cat lib/constants.js

# run Uglify:
for jsfile in $(find . -name "*.js" -type f | grep -v test) ; do
  uglifyjs --comments --compress --warn "$jsfile" -o "${jsfile}.tmp" && mv "${jsfile}.tmp" "$jsfile"
done
