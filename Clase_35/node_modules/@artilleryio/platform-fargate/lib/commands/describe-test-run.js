
module.exports = { describeTestRun: describeTestRunCommand };

const { describeTestRun } = require('../data-api/describe-test-run');
const setDefaultAWSCredentials = require('../utils/aws-set-default-credentials');
const whoami = require('../utils/aws-whoami');
const pkg = require('../../package.json');
const debugPerf = require('debug')('perf');

async function describeTestRunCommand(testId) {
  debugPerf('describeTestRunCommand');
  if (global.artillery && global.artillery.telemetry) {
    let awsAccountId = null;
    try {
      const stsResp = await whoami();
      awsAccountId = stsResp.Account;
    } catch (err) {
      console.log(err);
    }

    global.artillery.telemetry.capture('describe-test-run', {
      version: global.artillery.version,
      proVersion: pkg.version,
      awsAccountId,
    });
  }

  try {
    debugPerf('getting AWS credentials');
    await setDefaultAWSCredentials();
    debugPerf('got AWS credentials');
    const t = await describeTestRun(testId);
    console.log(JSON.stringify(t, null, 4));
  } catch (err) {
    console.log('An error occured')
    console.log(err.message);
    process.exit(1);
  }
}
