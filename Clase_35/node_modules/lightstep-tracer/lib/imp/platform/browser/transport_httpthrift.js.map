{"version":3,"sources":["../../../../src/imp/platform/browser/transport_httpthrift.js"],"names":[],"mappings":"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","file":"transport_httpthrift.js","sourcesContent":["export default class TransportBrowser {\n    constructor() {\n        this._host = '';\n        this._port = 0;\n        this._path = '';\n        this._encryption = '';\n    }\n\n    ensureConnection(opts) {\n        this._host = opts.collector_host;\n        this._port = opts.collector_port;\n        this._path = opts.collector_path;\n        this._encryption = opts.collector_encryption;\n    }\n\n    report(detached, auth, report, done) {\n        try {\n            if (!detached) {\n                this._reportAJAX(auth, report, done);\n            } else {\n                this._reportAsyncScript(auth, report, done);\n            }\n        } catch (e) {\n            return done(e, null);\n        }\n    }\n\n    _reportAJAX(auth, report, done) {\n        let payload = JSON.stringify(report.toThrift());\n        let protocol = (this._encryption === 'none') ? 'http' : 'https';\n        let url = `${protocol}://${this._host}:${this._port}${this._path}/api/v0/reports`;\n        let xhr = new XMLHttpRequest();\n        xhr.open('POST', url);\n        // Note: the browser automatically sets 'Connection' and 'Content-Length'\n        // and *does not* allow they to be set manually\n        xhr.setRequestHeader('LightStep-Access-Token', auth.getAccessToken());\n        xhr.setRequestHeader('Content-Type', 'application/json');\n        //req.setRequestHeader('Content-Encoding', 'gzip');\n        xhr.onreadystatechange = function () {\n            if (this.readyState === 4) {\n                let err = null;\n                let resp = null;\n                if (this.status !== 200) {\n                    err = new Error(`status code = ${this.status}`);\n                } else if (!this.responseText) {\n                    err = new Error('unexpected empty response');\n                } else {\n                    try {\n                        resp = JSON.parse(this.responseText);\n                    } catch (exception) {\n                        err = exception;\n                    }\n                }\n                return done(err, resp);\n            }\n        };\n        xhr.send(payload);\n    }\n\n    // Do a \"tail flush\" using an async browser script load.  This does not get\n    // interrupted as a normal Thirft RPC would when navigating away from\n    // the page.\n    _reportAsyncScript(auth, report, done) {\n        let authJSON   = JSON.stringify(auth.toThrift());\n        let reportJSON = JSON.stringify(report.toThrift());\n        let protocol = (this._encryption === 'none') ? 'http' : 'https';\n        let url = `${protocol}://${this._host}:${this._port}${this._path}/_rpc/v1/reports/uri_encoded`\n            + `?auth=${encodeURIComponent(authJSON)}`\n            + `&report=${encodeURIComponent(reportJSON)}`;\n\n        let elem = document.createElement('script');\n        elem.async = true;\n        elem.defer = true;\n        elem.src = url;\n        elem.type = 'text/javascript';\n\n        let hostElem = document.getElementsByTagName('head')[0];\n        if (hostElem) {\n            hostElem.appendChild(elem);\n        }\n        return done(null, null);\n    }\n}\n"]}