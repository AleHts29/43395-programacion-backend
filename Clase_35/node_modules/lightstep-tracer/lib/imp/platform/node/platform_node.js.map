{"version":3,"sources":["../../../../src/imp/platform/node/platform_node.js"],"names":[],"mappings":"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","file":"platform_node.js","sourcesContent":["const os = require('os');\nconst _each = require('../../../_each.js');\n\nfunction computeStartMicros() {\n    let startTimeMs = Date.now();\n    let startHrTime = process.hrtime();\n    let baseHrMicros = (startHrTime[0] * 1000000.0 + startHrTime[1] / 1000.0);\n\n    let startTimeMicros = (startTimeMs * 1000.0) - baseHrMicros;\n    return startTimeMicros;\n}\n\nlet startTimeMicros = computeStartMicros();\n\n// Local storage for Node is just memory\nlet gLocalStorage = {};\n\nexport default class PlatformNode {\n    constructor(imp) {\n        this._mustMatchVersion();\n    }\n\n    // An explicit runtime version check. The package.json cannot enforce the\n    // runtime version requirement in all circumstances.  See:\n    // http://www.marcusoft.net/2015/03/packagejson-and-engines-and-enginestrict.html\n    //\n    // Note: consider using the semver package if the logic in this function\n    // gets any more complex.\n    _mustMatchVersion() {\n        let actualMatch = /^v(\\d+)\\.(\\d+)\\.(\\d+)$/.exec(process.version);\n        if (!actualMatch || actualMatch.length !== 4) {\n            // The version string did not match the expected pattern;\n            // optimistically assume this is fine.\n            return;\n        }\n\n        let packageObject = require('../../../../package.json');\n        let requiredVersionString = packageObject.engines.node;\n        let requiredMatch = /^>=(\\d+)\\.(\\d+)\\.(\\d+)$/.exec(requiredVersionString);\n        if (!requiredMatch || requiredMatch.length !== 4) {\n            throw new Error('Internal error: package.json node requirement malformed');\n        }\n\n        let err = `Fatal Error: insufficient node version. Requires node ${requiredVersionString}`;\n        try {\n            let actual = [\n                parseInt(actualMatch[0], 10),\n                parseInt(actualMatch[1], 10),\n                parseInt(actualMatch[2], 10),\n            ];\n            let required = [\n                parseInt(requiredMatch[0], 10),\n                parseInt(requiredMatch[1], 10),\n                parseInt(requiredMatch[2], 10),\n            ];\n            if (actual[0] > required[0]) {\n                // eslint-disable-next-line no-empty\n            } else if (actual[0] < required[0]) {\n                this.fatal(err);\n            } else if (actual[1] > required[1]) {\n                // eslint-disable-next-line no-empty\n            } else if (actual[1] < required[1]) {\n                this.fatal(err);\n            } else if (actual[2] < required[2]) {\n                this.fatal(err);\n            }\n        } catch (e) {\n            // Optimistically ignore the unexpected version format and keep\n            // going.\n        }\n    }\n\n    name() {\n        return 'node';\n    }\n\n    /* eslint-disable no-empty */\n    static initLibrary(lib) {}\n    /* eslint-enable no-empty */\n\n    nowMicros() {\n        let hrTime = process.hrtime();\n        return Math.floor(startTimeMicros + hrTime[0] * 1000000.0 + hrTime[1] / 1000.0);\n    }\n\n    runtimeGUID(groupName) {\n        return this.generateUUID();\n    }\n\n    generateUUID() {\n        /* eslint-disable no-bitwise */\n        let p0 = `00000000${Math.abs((Math.random() * 0xFFFFFFFF) | 0).toString(16)}`.substr(-8);\n        let p1 = `00000000${Math.abs((Math.random() * 0xFFFFFFFF) | 0).toString(16)}`.substr(-8);\n        return `${p0}${p1}`;\n        /* eslint-enable no-bitwise */\n    }\n\n    onBeforeExit(...args) {\n        process.on('beforeExit', ...args);\n    }\n\n    plugins() {\n        return [\n            require('../../../plugins/instrument_nodejs'),\n        ];\n    }\n\n    options() {\n        if (!(process && process.argv)) {\n            return;\n        }\n        let opts = {};\n        _each(process.argv, (value, key) => {\n            // Keep the argument \"parsing\" simple.  These are primarily debug\n            // options regardless.\n            switch (value.toLowerCase()) {\n            case '--lightstep-log_to_console':\n            case '--lightstep-log_to_console=true':\n            case '--lightstep-log_to_console=1':\n                opts.log_to_console = true;\n                break;\n            case '--lightstep-verbosity=5':\n                opts.verbosity = 5;\n                break;\n            case '--lightstep-verbosity=4':\n                opts.verbosity = 4;\n                break;\n            case '--lightstep-verbosity=3':\n                opts.verbosity = 3;\n                break;\n            case '--lightstep-verbosity=2':\n                opts.verbosity = 2;\n                break;\n            case '--lightstep-verbosity=1':\n                opts.verbosity = 1;\n                break;\n            default:\n                // Ignore\n                break;\n            }\n        });\n        return opts;\n    }\n\n    tracerTags() {\n        let tags = {\n            'lightstep.tracer_platform'         : 'node',\n            'lightstep.tracer_platform_version' : process.version,\n            'lightstep.node_platform'           : process.platform,\n            'lightstep.node_arch'               : process.arch,\n            'lightstep.hostname'                : os.hostname(),\n        };\n        if (process.argv) {\n            tags['lightstep.command_line'] = process.argv.join(' ');\n        }\n        if (process.execArgv && process.execArgv.length > 0) {\n            tags['lightstep.node_arguments'] = process.execArgv.join(' ');\n        }\n\n        return tags;\n    }\n\n    fatal(message) {\n        console.error(message); // eslint-disable-line no-console\n        process.exit(1);\n    }\n\n    localStoreGet(key) {\n        return gLocalStorage[key];\n    }\n\n    localStoreSet(key, value) {\n        gLocalStorage[key] = value;\n    }\n}\n"]}