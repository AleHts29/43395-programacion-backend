{"version":3,"sources":["../../src/plugins/instrument_document_load.js"],"names":[],"mappings":"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","file":"instrument_document_load.js","sourcesContent":["import _each from '../_each';\n\nclass InstrumentPageLoad {\n    constructor() {\n        this._inited = false;\n        this._span = null;\n    }\n\n    name() {\n        return 'instrument_page_load';\n    }\n\n    addOptions(tracerImp) {\n        tracerImp.addOption('instrument_page_load', { type : 'bool', defaultValue : false });\n    }\n\n    start(tracerImp) {\n        if (this._inited) {\n            return;\n        }\n        this._inited = true;\n\n        if (typeof window !== 'object' || typeof document !== 'object') {\n            return;\n        }\n\n        const currentOptions = tracerImp.options();\n        if (currentOptions.instrument_page_load) {\n            this._ensureSpanStarted(tracerImp);\n            document.addEventListener('readystatechange', this._handleReadyStateChange.bind(this));\n        }\n    }\n\n    stop() {\n    }\n\n    _ensureSpanStarted(tracerImp) {\n        if (!this._span) {\n            this._span = tracerImp.startSpan('document/load');\n            tracerImp.addActiveRootSpan(this._span);\n        }\n    }\n\n    _handleReadyStateChange() {\n        if (!this._span) {\n            return;\n        }\n\n        let span = this._span;\n        let state = document.readyState;\n        let payload;\n        if (state === 'complete') {\n            payload = {};\n            if (window.performance && performance.timing) {\n                this._addTimingSpans(span, performance.timing);\n                payload['window.performance.timing'] = performance.timing;\n            }\n        }\n\n        span.logEvent(`document.readystatechange ${state}`, payload);\n\n        if (state === 'complete') {\n            if (span.tracer()) {\n                span.tracer().removeActiveRootSpan(span.tracer());\n            }\n            span.finish();\n        }\n    }\n\n    _copyNavigatorProperties(nav) {\n        let dst = {};\n        for (let key in nav) { // eslint-disable-line guard-for-in, no-restricted-syntax\n            try {\n                let value = nav[key];\n                switch (key) {\n                case 'plugins': {\n                    let p = [];\n                    for (let i = 0; i < value.length; i++) {\n                        let item = value.item(i);\n                        p.push({\n                            name        : item.name,\n                            description : item.description,\n                        });\n                    }\n                    dst[key] = p;\n                } break;\n\n                case 'mimeTypes': {\n                    let p = [];\n                    for (let i = 0; i < value.length; i++) {\n                        let item = value.item(i);\n                        p.push({\n                            type        : item.type,\n                            description : item.description,\n                            suffixes    : item.suffixes,\n                        });\n                    }\n                    dst[key] = p;\n                } break;\n\n                default:\n                    dst[key] = value;\n                    break;\n                }\n            } catch (e) {\n                // Skip, just in case\n            }\n        }\n        return dst;\n    }\n\n    // Retroactively create the appropriate spans and logs\n    _addTimingSpans(parentImp, timing) {\n        // NOTE: this currently relies on LightStep-specific APIs\n        if (!parentImp) {\n            return;\n        }\n\n        parentImp.setTag('user_agent', navigator.userAgent);\n\n        _each(timing, (value, key) => {\n            // e.g. secureConnectionStart is not always set\n            if (typeof value !== 'number' || value === 0) {\n                return;\n            }\n\n            let payload;\n\n            if (key === 'navigationStart' && typeof navigator === 'object') {\n                payload = {\n                    navigator : this._copyNavigatorProperties(navigator),\n                };\n            }\n            parentImp.log({\n                message : `document ${key}`,\n                payload : payload,\n            }, value);\n        });\n\n        parentImp.setBeginMicros(timing.navigationStart * 1000.0);\n\n        parentImp.tracer().startSpan('document/time_to_first_byte', { childOf : parentImp })\n            .setBeginMicros(timing.requestStart * 1000.0)\n            .setEndMicros(timing.responseStart * 1000.0)\n            .finish();\n        parentImp.tracer()\n            .startSpan('document/response_transfer', { childOf : parentImp })\n            .setBeginMicros(timing.responseStart * 1000.0)\n            .setEndMicros(timing.responseEnd * 1000.0)\n            .finish();\n        parentImp.tracer().startSpan('document/dom_load', { childOf : parentImp })\n            .setBeginMicros(timing.domLoading * 1000.0)\n            .setEndMicros(timing.domInteractive * 1000.0)\n            .finish();\n    }\n}\n\nmodule.exports = new InstrumentPageLoad();\n"]}